name: Preview Deployment (Fly.io)

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

concurrency:
  group: preview-${{ github.head_ref }}
  cancel-in-progress: true

env:
  FLY_API_TOKEN: ${{ secrets.YRAL_AUTH_V2_FLY_IO_GITHUB_ACTION }}

jobs:
  build_check:
    if: github.event.action != 'closed'
    uses: ./.github/workflows/build-check.yml
    with:
      publish-artifact: true

  preview:
    name: Deploy Preview
    if: github.event.action != 'closed'
    needs: build_check
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-musl

      - run: chmod +x target/x86_64-unknown-linux-musl/release/yral-auth-v2

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create fly.toml for preview
        run: |
          cat > fly.toml << 'EOF'
          app = 'yral-auth-v2-preview-${{ github.event.pull_request.number }}'
          primary_region = 'sin'

          [build]

          [env]
            PORT = '8080'
            GOOGLE_CLIENT_ID = '804814798298-taifmq3k6olk9bjr1cqb9gfnp1mssqqb.apps.googleusercontent.com'
            JWT_PUB_EC_PEM = """-----BEGIN PUBLIC KEY-----
          MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEoqN3/0RNfrnrnYGxKBgy/qHnmITr
          +6ucjxStx7tjA30QJZlWzo0atxmY8y9dUR+eKQI0SnbQds4xLEU8+JGm8Q==
          -----END PUBLIC KEY-----"""
            SERVER_URL = "https://yral-auth-v2-preview-${{ github.event.pull_request.number }}.fly.dev/"
            APPLE_CLIENT_ID = "com.yral.yral-auth"
            APPLE_TEAM_ID = "2UL556KNXC"
            APPLE_KEY_ID = "9DWVYWDYD8"
            CLIENT_JWT_PUB_ED_PEM = """-----BEGIN PUBLIC KEY-----
          MCowBQYDK2VwAyEAKpZNfPOONR9AXiaGmHv8AHemm4SNK0uh+mf523ho5KU=
          -----END PUBLIC KEY-----"""

          [http_service]
            internal_port = 8080
            force_https = true
            auto_stop_machines = 'stop'
            auto_start_machines = true
            min_machines_running = 0

          [[vm]]
            memory = '512mb'
            cpu_kind = 'shared'
            cpus = 1
          EOF

      - name: Create Fly app if not exists
        run: |
          flyctl apps create yral-auth-v2-preview-${{ github.event.pull_request.number }} --org gobazzinga-inc-584 || true

      - name: Set secrets
        run: |
          flyctl secrets set \
            COOKIE_KEY="$COOKIE_KEY" \
            REDIS_URL="$REDIS_URL" \
            GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
            JWT_EC_PEM="$JWT_EC_PEM" \
            CLIENT_JWT_ED_PEM="$CLIENT_JWT_ED_PEM" \
            APPLE_AUTH_KEY_PEM="$APPLE_AUTH_KEY_PEM" \
            --app yral-auth-v2-preview-${{ github.event.pull_request.number }} \
            --stage
        env:
          COOKIE_KEY: ${{ secrets.AUTH_SESSION_COOKIE_SIGNING_SECRET_KEY }}
          REDIS_URL: ${{ secrets.AUTH_FLY_IO_UPSTASH_REDIS_DATABASE_CONNECTION_STRING }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_SIGNING_OAUTH_CLIENT_CREDENTIAL_CLIENT_SECRET }}
          JWT_EC_PEM: ${{ secrets.AUTH_JWT_ES256_SIGNING_SECRET_KEY_PEM }}
          CLIENT_JWT_ED_PEM: ${{ secrets.CLIENT_JWT_ED_PEM }}
          APPLE_AUTH_KEY_PEM: ${{ secrets.APPLE_AUTH_KEY_PEM }}

      - name: Deploy to Fly.io
        id: deploy
        run: |
          flyctl deploy --remote-only --app yral-auth-v2-preview-${{ github.event.pull_request.number }}
          echo "url=https://yral-auth-v2-preview-${{ github.event.pull_request.number }}.fly.dev" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview deployed to: https://yral-auth-v2-preview-${{ github.event.pull_request.number }}.fly.dev`
            })

  cleanup:
    name: Cleanup Preview
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Destroy preview app
        run: |
          flyctl apps destroy yral-auth-v2-preview-${{ github.event.pull_request.number }} --yes || true
        env:
          FLY_API_TOKEN: ${{ secrets.YRAL_AUTH_V2_FLY_IO_GITHUB_ACTION }}
